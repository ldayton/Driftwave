name: Build Linux

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.0-dev \
          libwebkit2gtk-4.1-dev \
          build-essential \
          curl \
          wget \
          file \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libjavascriptcoregtk-4.0-dev \
          libjavascriptcoregtk-4.1-dev \
          libsoup2.4-dev

    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install Node dependencies
      run: npm ci

    - name: Build Tauri app
      run: npm run tauri build

    - name: Upload deb artifact
      uses: actions/upload-artifact@v3
      with:
        name: driftwave-linux-deb
        path: target/release/bundle/deb/*.deb

    - name: Upload rpm artifact
      uses: actions/upload-artifact@v3
      with:
        name: driftwave-linux-rpm
        path: target/release/bundle/rpm/*.rpm

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v3
      with:
        name: driftwave-linux-appimage
        path: target/release/bundle/appimage/*.AppImage
      if: success() || failure()